---
layout:     post
title:      DSQ论文分析笔记
subtitle:   Differentiable Soft Quantization
date:       2020-03-25
author:     DT
header-img: img/post-bg-debug.png
catalog: true
tags:
    - notes
    - paper.reading



---

> DSQ

# overview

在模型量化中，假如待量化的数值$w$恰好就是量化后的数值$w_q$，那么STE的作用就相当于$f(x)=x$的恒等映射函数，然后在梯度反传的时候也就不会出现量化所带来的梯度偏离，但是一般情况下是不会出现$w=w_q$这种情况的，所以使用STE势必会带来一定的梯度偏离（在backward时候），那么如果我们能够先使用一个连续且处处可微的函数$f$，让$f(w)$很逼近于$w_q$，那么直观上在一定程度上可以缓解STE所带来的梯度偏离。DSQ这篇文章就是这样的一个思路。

# 均匀量化

譬如DoReFa-Net，将一个量化区$[l,u]$间使用$b$-bit进行量化，那么
$$
\Delta = (u-l) / (2^b-1)
$$
($b$-bit形成了$2^b-1$个区间)表示单位区间的长度，量化函数为：
$$
Q_u(x) = \text{round}(\frac{x-l}{u-l}(2^b-1))*\Delta+l=\text{round}(\frac{x-l}{\Delta})*\Delta+l
$$
对于一个待量化的区间$P_i = [l+i*\Delta,l+(i+1)*\Delta],i\in\{0,1,...,2^b-2\}$，经过量化函数，前一半被量化为$l+i*\Delta$，后一半被量化为$l+(i+1)*\Delta$。

# DSQ

DSQ通过将每一个量化区间$P_i$先映射到$[-1,+1]$，然后通过下列$Q_s$函数来cover整个量化区间：
$$
Q_s(x) = 
\begin{cases}
l, & x < l \\
u, & x > u \\
l + \Delta(i+\frac{\varphi(x)+1}{2}), & x\in P_i
\end{cases}
$$
注意这里$Q_s$函数关于$\varphi(x)$至少是连续可微的，同时可见如果$\varphi(x)$函数只取$\{-1,+1\}$两个值，便可完全实现对整个量化区间的量化。所以，$\varphi(x)$函数则是DSQ的核心，通过借助tanh函数来逼近/模拟sign函数：
$$
\varphi(x) = s*\mbox{tanh}(k*(x-m_i)), \quad \mbox{if} \quad x\in P_i
$$
其中$m_i = l+(i+0.5)*\Delta$（这个$m_i$本质上就是区间$P_i$的中心），$s=\frac{1}{\mbox{tanh}(0.5k\Delta)}$，$k$为控制tanh函数陡峭程度的参数，也便决定了对sign函数的逼近程度。可见$\varphi(x)$所得到的值也还是连续的，也就是尚未得到我们想要的量化值，所以在实际量化的时候还需要$sign(\varphi(x))$。

综上可见，粗略的DQS的forward过程为：$Q_s(sign(\varphi(x)))$，可视化如下图（设置了$l=0,u=8,b=2,k=8$）：

1. 将各个区间$P_i$映射到$[-1,+1]$

![dsq1](img/post-imgs/dsq1.png)

2. 量化到$\{-1,+1\}$

![dqs2](img/post-imgs/dsq2.png)

3. cover整个量化区间（进行平移拼接）

![dsq3](img/post-imgs/dsq3.png)

不带量化的DSQ：

![dsq4](img/post-imgs/dsq4.png)

另外，DSQ引入了一个characteristic variable $\alpha$来作为$\varphi$函数对$\mbox{sign}$函数的逼近程度：
$$
\alpha = 1 - \mbox{tanh}(0.5k\Delta)
$$
（虽然直观来看$\alpha$趋于0时，$k$区域无穷大，势必会更好地拟合$\mbox{sign}$函数，但是真正的拟合程度不应该是由$\varphi(x),y=1,x=0$所形成的面积（$\int_{0}^{0.5k\Delta}s\mbox{tanh}(x)\,dx = s\ln(\mbox{cosh}x)|_{0}^{0.5k\Delta},\mbox{cosh}x=\frac{e^x+e^{-x}}{2}$）来确定的吗？为什么不这么做？估计觉得麻烦吧）；以及将$l,u$都作为参数直接学习了。

# algorithm

![dsq5](img/post-imgs/dsq5.png)

# reference

* https://arxiv.org/abs/1908.05033